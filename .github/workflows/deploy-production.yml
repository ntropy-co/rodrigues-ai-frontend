name: Deploy Production

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validation (Lint & Typecheck)
        run: |
          echo "Running validation from reusable workflow..."
          # Ideally we call reusable workflow here, but 'uses' cannot be conditioned easily inside steps of a job?
          # Actually 'uses' at job level supports 'if'.
          # So separating job is correct.

  # Wait, 'uses' defines the job content. I cannot mix 'steps' and 'uses' in same job.
  # So I define 'validate' job using 'uses'.

  validate-checks:
    uses: ./.github/workflows/validate.yml
    secrets: inherit

  deploy:
    needs: [validate-checks]
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: production
      vercel_env: production
      vercel_prod_flag: true
    secrets: inherit

  create-release:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()
    steps:
      - uses: actions/checkout@v4
      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0]
            github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: `v${date}-${context.sha.substring(0, 7)}`,
              name: `Production Deploy ${date}`,
              body: `Deployed to production by @${context.actor}`,
              generate_release_notes: true
            })
